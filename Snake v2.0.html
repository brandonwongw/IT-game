<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²ªé£Ÿè›‡å¢å¼·ç‰ˆ - å¤šæ¨¡å¼æŒ‘æˆ°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 10px;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: #4dff91;
            text-shadow: 0 0 10px rgba(77, 255, 145, 0.5);
        }
        
        .subtitle {
            font-size: 1rem;
            color: #a0a0c0;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 600px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .info-box {
            text-align: center;
            min-width: 80px;
        }
        
        .score-label { font-size: 0.9rem; color: #a0a0c0; }
        .score { font-size: 1.8rem; font-weight: bold; color: #4dff91; }
        .time-label { font-size: 0.9rem; color: #a0a0c0; }
        .time { font-size: 1.5rem; font-weight: bold; color: #4d9fff; }
        
        .game-board-container {
            position: relative;
            width: 100%;
            background-color: transparent; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #gameCanvas {
            border-radius: 10px;
            background-color: #0f3460;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: block;
            border: 4px solid rgba(255, 77, 77, 0.3);
        }

        .shake {
            border: 4px solid red !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        /* æ¨¡å¼é¸æ“‡å™¨ */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 5px;
            width: 100%;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px 5px;
            font-size: 0.85rem;
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 70px;
        }
        
        .mode-btn.active { background-color: #ff9a4d; }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 5px;
            width: 100%;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            flex: 1;
            padding: 8px 5px;
            font-size: 0.85rem;
            background-color: #4d9fff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 60px;
        }
        
        .difficulty-btn.active { background-color: #ff9a4d; }

        .skin-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
            width: 100%;
        }

        .skin-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .skin-option.selected {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-top: 10px;
        }
        
        button.action-btn {
            padding: 10px 25px;
            font-size: 1rem;
            background-color: #4dff91;
            color: #16213e;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        button.action-btn:active { transform: scale(0.95); }

        #restartBtn { background-color: #ff9a4d; }
        #pauseBtn { background-color: #4d9fff; }
        
        /* éŠæˆ²çµæŸç•«é¢ */
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            z-index: 20;
            width: 80%;
            max-width: 350px;
            display: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            border: 2px solid #ff4d4d;
        }
        
        .game-over h2 { color: #ff4d4d; margin-bottom: 10px; font-size: 2rem; }
        .game-over p { margin-bottom: 5px; font-size: 1rem; }
        
        /* æˆå°±å½ˆçª— */
        .achievement-popup {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 30;
            display: none;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .achievement-popup h3 { color: #ffd700; margin-bottom: 5px; }
        
        /* æˆå°±æŒ‰éˆ• */
        .achievements-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
        }
        
        /* æˆå°±é é¢ */
        .achievements-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .achievements-content {
            background-color: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .achievements-content h2 { 
            color: #ffd700; 
            text-align: center; 
            margin-bottom: 20px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .achievement-icon {
            font-size: 2rem;
            margin-right: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .achievement-info h4 { color: #fff; margin-bottom: 5px; }
        .achievement-info p { color: #a0a0c0; font-size: 0.9rem; }
        
        .achievement-locked { opacity: 0.5; }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        /* åˆ†äº«æŒ‰éˆ• */
        .share-btn {
            position: fixed;
            top: 60px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
        }
        
        /* è¨­å®šæŒ‰éˆ• */
        .settings-btn {
            position: fixed;
            top: 110px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
        }
        
        /* è¨­å®šé¢æ¿ */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background-color: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .setting-item input[type="range"] {
            width: 100%;
        }
        
        .instructions {
            font-size: 0.9rem;
            color: #c0c0e0;
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
        }

        .item-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 5px;
            font-size: 1.2rem;
        }
        
        /* éšœç¤™ç‰©æ¨£å¼ */
        .obstacle-preview {
            background-color: #7f8c8d;
            border-radius: 3px;
        }
        
        /* çµ„åˆé€£æ“Šé¡¯ç¤º */
        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            z-index: 5;
            display: none;
        }

        /* PC ç«¯æ¨£å¼å„ªåŒ– */
        @media (min-width: 601px) {
            #gameCanvas { width: 400px; height: 400px; }
        }
        
        /* éŠæˆ²æ¨¡å¼æ¨™ç±¤ */
        .mode-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 5;
        }
        
        .time-mode { color: #4d9fff; border: 1px solid #4d9fff; }
        .survival-mode { color: #e74c3c; border: 1px solid #e74c3c; }
        .classic-mode { color: #2ecc71; border: 1px solid #2ecc71; }
    </style>
</head>
<body>
    <!-- æˆå°±æŒ‰éˆ• -->
    <button class="achievements-btn" id="achievementsBtn">ğŸ†</button>
    
    <!-- åˆ†äº«æŒ‰éˆ• -->
    <button class="share-btn" id="shareBtn">ğŸ“¤</button>
    
    <!-- è¨­å®šæŒ‰éˆ• -->
    <button class="settings-btn" id="settingsBtn">âš™ï¸</button>
    
    <div class="header">
        <h1>è²ªé£Ÿè›‡å¢å¼·ç‰ˆ</h1>
        <p class="subtitle">å¤šæ¨¡å¼æŒ‘æˆ° â€¢ æˆå°±ç³»çµ± â€¢ è¦–è¦ºç‰¹æ•ˆ</p>
    </div>
    
    <div class="game-container">
        <!-- è¨ˆåˆ†æ¿ -->
        <div class="game-info">
            <div class="info-box">
                <div class="score-label">åˆ†æ•¸</div>
                <div class="score" id="score">0</div>
            </div>
            <div class="info-box">
                <div class="score-label">æœ€é«˜åˆ†</div>
                <div class="score" id="highScore">0</div>
            </div>
            <div class="info-box">
                <div class="time-label">æ™‚é–“</div>
                <div class="time" id="timeDisplay">00:00</div>
            </div>
            <div class="info-box">
                <div class="score-label">é€£æ“Š</div>
                <div class="score" id="comboCount">0</div>
            </div>
        </div>

        <!-- éŠæˆ²æ¨¡å¼é¸æ“‡ -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="classic">ç¶“å…¸æ¨¡å¼</button>
            <button class="mode-btn" data-mode="time">æ™‚é–“æŒ‘æˆ°</button>
            <button class="mode-btn" data-mode="survival">ç”Ÿå­˜æ¨¡å¼</button>
        </div>
        
        <!-- çš®è†šé¸æ“‡ -->
        <div class="skin-selector">
            <div class="skin-option selected" style="background-color: #4dff91;" onclick="setSkin('#4dff91', this)"></div>
            <div class="skin-option" style="background-color: #ff4d4d;" onclick="setSkin('#ff4d4d', this)"></div>
            <div class="skin-option" style="background-color: #4d9fff;" onclick="setSkin('#4d9fff', this)"></div>
            <div class="skin-option" style="background-color: #ffd700;" onclick="setSkin('#ffd700', this)"></div>
            <div class="skin-option" style="background-color: #9b59b6;" onclick="setSkin('#9b59b6', this)"></div>
        </div>
        
        <!-- å›°é›£åº¦é¸æ“‡ -->
        <div class="difficulty-selector">
            <button class="difficulty-btn active" data-diff="easy">ç°¡å–®</button>
            <button class="difficulty-btn" data-diff="normal">æ™®é€š</button>
            <button class="difficulty-btn" data-diff="hard">å›°é›£</button>
            <button class="difficulty-btn" data-diff="expert">å°ˆå®¶</button>
            <button class="difficulty-btn" data-diff="insane">ç˜‹ç‹‚</button>
        </div>
        
        <!-- éŠæˆ²ä¸»å®¹å™¨ -->
        <div class="game-board-container">
            <!-- æ¨¡å¼æ¨™ç¤º -->
            <div class="mode-indicator classic-mode" id="modeIndicator">ç¶“å…¸æ¨¡å¼</div>
            
            <!-- é€£æ“Šé¡¯ç¤º -->
            <div class="combo-display" id="comboDisplay"></div>
            
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            
            <!-- æˆå°±å½ˆçª— -->
            <div class="achievement-popup" id="achievementPopup">
                <h3>æˆå°±è§£é–ï¼</h3>
                <p id="achievementName"></p>
                <p id="achievementDesc"></p>
            </div>
            
            <!-- éŠæˆ²çµæŸç•«é¢ -->
            <div class="game-over" id="gameOverScreen">
                <h2>éŠæˆ²çµæŸ</h2>
                <p>åˆ†æ•¸: <span id="finalScore">0</span></p>
                <p>æ¨¡å¼: <span id="finalMode">ç¶“å…¸æ¨¡å¼</span></p>
                <p>å›°é›£åº¦: <span id="finalDiff">ç°¡å–®</span></p>
                <p>éŠæˆ²æ™‚é–“: <span id="finalTime">00:00</span></p>
                <p id="newRecordMsg" style="display:none; color:#4dff91; font-weight:bold;">ğŸ‰ æ–°ç´€éŒ„ï¼ ğŸ‰</p>
                <div id="achievementsEarned" style="margin-top:10px;"></div>
                <button class="action-btn" id="playAgainBtn" style="margin-top:10px; width:100%;">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="controls">
            <button id="startBtn" class="action-btn">é–‹å§‹</button>
            <button id="pauseBtn" class="action-btn">æš«åœ</button>
            <button id="restartBtn" class="action-btn">é‡ç½®</button>
        </div>
        
        <!-- éŠæˆ²èªªæ˜ -->
        <div class="instructions">
            <p>ä½¿ç”¨ <strong>WASD</strong> æˆ– <strong>â†‘â†“â†â†’</strong> æ§åˆ¶ç§»å‹•</p>
            <div class="item-legend">
                <span title="è˜‹æœ +10åˆ†">ğŸ</span>
                <span title="è‘¡è„ +50åˆ†">ğŸ‡</span>
                <span title="ç‚¸å½ˆ -50åˆ†">ğŸ’£</span>
                <span title="éšœç¤™ç‰© (ç”Ÿå­˜æ¨¡å¼)">â¬›</span>
            </div>
        </div>
    </div>
    
    <!-- æˆå°±æ¨¡æ…‹æ¡† -->
    <div class="achievements-modal" id="achievementsModal">
        <div class="achievements-content">
            <h2>ğŸ† æˆå°±ç³»çµ±</h2>
            <button class="close-modal" id="closeAchievements">&times;</button>
            <div id="achievementsList">
                <!-- æˆå°±å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
            <button class="close-modal" id="closeSettings">&times;</button>
            
            <div class="setting-item">
                <label for="musicVolume">èƒŒæ™¯éŸ³æ¨‚éŸ³é‡</label>
                <input type="range" id="musicVolume" min="0" max="100" value="50">
            </div>
            
            <div class="setting-item">
                <label for="soundVolume">éŸ³æ•ˆéŸ³é‡</label>
                <input type="range" id="soundVolume" min="0" max="100" value="70">
            </div>
            
            <div class="setting-item">
                <label for="showEffects">é¡¯ç¤ºè¦–è¦ºç‰¹æ•ˆ</label>
                <input type="checkbox" id="showEffects" checked>
            </div>
            
            <button class="action-btn" id="saveSettings" style="width:100%; margin-top:20px;">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // DOM å…ƒç´ 
        const scoreEl = document.getElementById('score');
        const highScoreEl = document.getElementById('highScore');
        const timeDisplay = document.getElementById('timeDisplay');
        const comboCount = document.getElementById('comboCount');
        const comboDisplay = document.getElementById('comboDisplay');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreEl = document.getElementById('finalScore');
        const finalModeEl = document.getElementById('finalMode');
        const finalDiffEl = document.getElementById('finalDiff');
        const finalTimeEl = document.getElementById('finalTime');
        const newRecordMsg = document.getElementById('newRecordMsg');
        const achievementsEarned = document.getElementById('achievementsEarned');
        const achievementPopup = document.getElementById('achievementPopup');
        const achievementName = document.getElementById('achievementName');
        const achievementDesc = document.getElementById('achievementDesc');
        const modeIndicator = document.getElementById('modeIndicator');
        
        // éŠæˆ²ç‹€æ…‹
        let snake = [];
        let items = []; // æ°´æœé™£åˆ—
        let obstacles = []; // éšœç¤™ç‰© (ç”Ÿå­˜æ¨¡å¼)
        let bomb = null; // ç‚¸å½ˆ
        let direction = 'right';
        let nextDirection = 'right';
        let score = 0;
        let combo = 0;
        let comboTimeout = null;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoop;
        let gameSpeed = 150;
        let currentMode = 'classic'; // classic, time, survival
        let currentDifficulty = 'easy';
        let skinColor = '#4dff91';
        let gameTime = 0; // éŠæˆ²æ™‚é–“ (ç§’)
        let timeLimit = 180; // æ™‚é–“æŒ‘æˆ°æ¨¡å¼æ™‚é–“é™åˆ¶ (ç§’)
        let gameTimer;
        
        // ç²’å­æ•ˆæœé™£åˆ—
        let particles = [];
        
        // æˆå°±ç³»çµ±
        let achievements = JSON.parse(localStorage.getItem('snakeAchievements')) || {};
        let unlockedAchievements = new Set(); // æœ¬æ¬¡éŠæˆ²è§£é–çš„æˆå°±
        
        // éŠæˆ²è¨­å®š
        let settings = JSON.parse(localStorage.getItem('snakeSettings')) || {
            musicVolume: 50,
            soundVolume: 70,
            showEffects: true
        };
        
        // é«˜åˆ†è¨˜éŒ„
        let highScores = JSON.parse(localStorage.getItem('snakeHighScores')) || {};
        
        // éŠæˆ²æ¨¡å¼è¨­å®š
        const gameModes = {
            classic: { name: "ç¶“å…¸æ¨¡å¼", timeLimit: null },
            time: { name: "æ™‚é–“æŒ‘æˆ°", timeLimit: 180 }, // 3åˆ†é˜
            survival: { name: "ç”Ÿå­˜æ¨¡å¼", timeLimit: null }
        };
        
        // å›°é›£åº¦è¨­å®š
        const difficultySettings = {
            easy: { name: "ç°¡å–®", speed: 150, minSpeed: 80, obstacleSpawnTime: 60 },
            normal: { name: "æ™®é€š", speed: 120, minSpeed: 60, obstacleSpawnTime: 45 },
            hard: { name: "å›°é›£", speed: 90, minSpeed: 40, obstacleSpawnTime: 30 },
            expert: { name: "å°ˆå®¶", speed: 70, minSpeed: 25, obstacleSpawnTime: 20 },
            insane: { name: "ç˜‹ç‹‚", speed: 50, minSpeed: 10, obstacleSpawnTime: 15 }
        };
        
        // æˆå°±å®šç¾©
        const achievementDefinitions = [
            { id: 'first_game', name: 'åˆå‡ºèŒ…å»¬', description: 'å®Œæˆç¬¬ä¸€å ´éŠæˆ²', icon: 'ğŸ®', condition: (stats) => stats.gamesPlayed >= 1 },
            { id: 'score_100', name: 'ç™¾åˆ†é”äºº', description: 'å–®å ´éŠæˆ²é”åˆ°100åˆ†', icon: 'ğŸ’¯', condition: (stats) => stats.highScore >= 100 },
            { id: 'score_500', name: 'äº”ç™¾å¤§å¸«', description: 'å–®å ´éŠæˆ²é”åˆ°500åˆ†', icon: 'ğŸ†', condition: (stats) => stats.highScore >= 500 },
            { id: 'fruit_collector', name: 'æ°´æœæ”¶è—å®¶', description: 'æ”¶é›†æ‰€æœ‰ç¨®é¡çš„æ°´æœ', icon: 'ğŸ', condition: (stats) => stats.fruitsCollected.apple > 0 && stats.fruitsCollected.grape > 0 },
            { id: 'bomb_survivor', name: 'ç‚¸å½ˆç”Ÿå­˜è€…', description: 'ä¸€å ´éŠæˆ²ä¸­èº²é¿5å€‹ç‚¸å½ˆ', icon: 'ğŸ’£', condition: (stats) => stats.bombsAvoided >= 5 },
            { id: 'combo_master', name: 'é€£æ“Šå¤§å¸«', description: 'é”æˆ10é€£æ“Š', icon: 'âš¡', condition: (stats) => stats.maxCombo >= 10 },
            { id: 'time_challenge', name: 'æ™‚é–“æˆ°å£«', description: 'åœ¨æ™‚é–“æŒ‘æˆ°æ¨¡å¼ç²å¾—200åˆ†', icon: 'â±ï¸', condition: (stats) => stats.timeModeScore >= 200 },
            { id: 'survival_expert', name: 'ç”Ÿå­˜å°ˆå®¶', description: 'åœ¨ç”Ÿå­˜æ¨¡å¼å­˜æ´»5åˆ†é˜', icon: 'ğŸ›¡ï¸', condition: (stats) => stats.survivalTime >= 300 },
            { id: 'all_difficulties', name: 'å…¨èƒ½æŒ‘æˆ°è€…', description: 'åœ¨æ‰€æœ‰å›°é›£åº¦ä¸‹æ¸¸ç©é', icon: 'ğŸŒŸ', condition: (stats) => stats.difficultiesPlayed.length >= 5 },
            { id: 'speed_demon', name: 'é€Ÿåº¦æƒ¡é­”', description: 'åœ¨ç˜‹ç‹‚é›£åº¦ä¸‹æ¸¸ç©', icon: 'ğŸŒ€', condition: (stats) => stats.difficultiesPlayed.includes('insane') }
        ];
        
        // éŠæˆ²çµ±è¨ˆ
        let gameStats = JSON.parse(localStorage.getItem('snakeGameStats')) || {
            gamesPlayed: 0,
            highScore: 0,
            fruitsCollected: { apple: 0, grape: 0 },
            bombsAvoided: 0,
            maxCombo: 0,
            timeModeScore: 0,
            survivalTime: 0,
            difficultiesPlayed: []
        };
        
        // ç¶²æ ¼è¨­å®š
        const gridSize = 20;
        const gridWidth = canvas.width / gridSize;
        const gridHeight = canvas.height / gridSize;
        
        // ç‰©å“é¡å‹
        const itemTypes = [
            { type: 'apple', emoji: 'ğŸ', score: 10, chance: 0.6 },
            { type: 'grape', emoji: 'ğŸ‡', score: 50, chance: 0.4 }
        ];
        
        // åˆå§‹åŒ–éŠæˆ²
        function init() {
            // æ›´æ–°æœ€é«˜åˆ†é¡¯ç¤º
            const scoreKey = `${currentMode}_${currentDifficulty}`;
            highScores[scoreKey] = highScores[scoreKey] || 0;
            highScoreEl.innerText = highScores[scoreKey];
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            snake = [
                {x: 5, y: 10}, 
                {x: 4, y: 10}, 
                {x: 3, y: 10}, 
                {x: 2, y: 10}
            ];
            score = 0;
            combo = 0;
            scoreEl.innerText = score;
            comboCount.innerText = combo;
            direction = 'right';
            nextDirection = 'right';
            gameTime = 0;
            timeDisplay.innerText = '00:00';
            
            // æ ¹æ“šæ¨¡å¼è¨­å®šéŠæˆ²é€Ÿåº¦
            gameSpeed = difficultySettings[currentDifficulty].speed;
            
            // æ¸…ç©ºç‰©å“å’Œéšœç¤™ç‰©
            items = [];
            obstacles = [];
            bomb = null;
            particles = [];
            
            // ç”Ÿæˆåˆå§‹æ°´æœ
            generateFruits(2 + Math.floor(Math.random() * 2));
            
            // ç”Ÿæˆç‚¸å½ˆ
            generateBomb();
            
            // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
            updateModeIndicator();
            
            // é‡ç½®æœ¬æ¬¡éŠæˆ²è§£é–çš„æˆå°±
            unlockedAchievements.clear();
            
            // ç¹ªè£½åˆå§‹ç•«é¢
            drawGame();
            
            // æ›´æ–°çµ±è¨ˆä¸­çš„é›£åº¦è¨˜éŒ„
            if (!gameStats.difficultiesPlayed.includes(currentDifficulty)) {
                gameStats.difficultiesPlayed.push(currentDifficulty);
                saveGameStats();
            }
        }
        
        // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
        function updateModeIndicator() {
            modeIndicator.textContent = gameModes[currentMode].name;
            modeIndicator.className = 'mode-indicator';
            
            if (currentMode === 'time') {
                modeIndicator.classList.add('time-mode');
            } else if (currentMode === 'survival') {
                modeIndicator.classList.add('survival-mode');
            } else {
                modeIndicator.classList.add('classic-mode');
            }
        }
        
        // ç”Ÿæˆæ°´æœ
        function generateFruits(count) {
            for(let i = 0; i < count; i++) {
                spawnOneItem();
            }
        }
        
        function spawnOneItem() {
            let valid = false;
            let newItem = {};
            
            while(!valid) {
                newItem = {
                    x: Math.floor(Math.random() * gridWidth),
                    y: Math.floor(Math.random() * gridHeight)
                };
                
                valid = isPositionValid(newItem.x, newItem.y);
            }
            
            const rand = Math.random();
            const type = rand < 0.6 ? itemTypes[0] : itemTypes[1];
            
            newItem.type = type.type;
            newItem.emoji = type.emoji;
            newItem.scoreVal = type.score;
            
            items.push(newItem);
        }
        
        // ç”Ÿæˆç‚¸å½ˆ
        function generateBomb() {
            let valid = false;
            let newBomb = {};
            
            while(!valid) {
                newBomb = {
                    x: Math.floor(Math.random() * gridWidth),
                    y: Math.floor(Math.random() * gridHeight)
                };
                
                valid = isPositionValid(newBomb.x, newBomb.y);
            }
            
            newBomb.type = 'bomb';
            newBomb.emoji = 'ğŸ’£';
            newBomb.scoreVal = -50;
            newBomb.spawnTime = Date.now();
            newBomb.duration = 3000 + Math.random() * 4000;
            newBomb.warning = false; // æ˜¯å¦æ­£åœ¨è­¦å‘Š
            
            bomb = newBomb;
        }
        
        // ç”Ÿæˆéšœç¤™ç‰© (ç”Ÿå­˜æ¨¡å¼)
        function generateObstacle() {
            let valid = false;
            let newObstacle = {};
            
            // å˜—è©¦æœ€å¤š50æ¬¡æ‰¾åˆ°æœ‰æ•ˆä½ç½®
            let attempts = 0;
            while(!valid && attempts < 50) {
                newObstacle = {
                    x: Math.floor(Math.random() * gridWidth),
                    y: Math.floor(Math.random() * gridHeight)
                };
                
                valid = isPositionValid(newObstacle.x, newObstacle.y);
                attempts++;
            }
            
            if (valid) {
                obstacles.push(newObstacle);
                createParticles(newObstacle.x * gridSize + gridSize/2, newObstacle.y * gridSize + gridSize/2, '#7f8c8d', 5);
            }
        }
        
        // æª¢æŸ¥ä½ç½®æ˜¯å¦æœ‰æ•ˆ
        function isPositionValid(x, y) {
            // æª¢æŸ¥æ˜¯å¦èˆ‡è›‡èº«é‡ç–Š
            for(let part of snake) {
                if(part.x === x && part.y === y) return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦èˆ‡æ°´æœé‡ç–Š
            for(let item of items) {
                if(item.x === x && item.y === y) return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦èˆ‡ç‚¸å½ˆé‡ç–Š
            if(bomb && bomb.x === x && bomb.y === y) return false;
            
            // æª¢æŸ¥æ˜¯å¦èˆ‡éšœç¤™ç‰©é‡ç–Š
            for(let obstacle of obstacles) {
                if(obstacle.x === x && obstacle.y === y) return false;
            }
            
            return true;
        }
        
        // ç¹ªè£½éŠæˆ²
        function drawGame() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½ç¶²æ ¼
            drawGrid();
            
            // ç¹ªè£½éšœç¤™ç‰© (ç”Ÿå­˜æ¨¡å¼)
            drawObstacles();
            
            // ç¹ªè£½æ°´æœ
            drawItems();
            
            // ç¹ªè£½ç‚¸å½ˆ
            drawBomb();
            
            // ç¹ªè£½ç²’å­æ•ˆæœ
            drawParticles();
            
            // ç¹ªè£½è›‡
            drawSnake();
        }
        
        // ç¹ªè£½ç¶²æ ¼
        function drawGrid() {
            ctx.strokeStyle = '#1a508b';
            ctx.lineWidth = 0.5;
            
            // å‚ç›´ç·š
            for(let i = 0; i <= canvas.width; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            
            // æ°´å¹³ç·š
            for(let i = 0; i <= canvas.height; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
        }
        
        // ç¹ªè£½éšœç¤™ç‰©
        function drawObstacles() {
            if (currentMode !== 'survival') return;
            
            ctx.fillStyle = '#7f8c8d';
            for(let obstacle of obstacles) {
                ctx.fillRect(
                    obstacle.x * gridSize + 1, 
                    obstacle.y * gridSize + 1, 
                    gridSize - 2, 
                    gridSize - 2
                );
                
                // æ·»åŠ å…§éƒ¨é™°å½±æ•ˆæœ
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(
                    obstacle.x * gridSize + 4, 
                    obstacle.y * gridSize + 4, 
                    gridSize - 8, 
                    gridSize - 8
                );
                ctx.fillStyle = '#7f8c8d';
            }
        }
        
        // ç¹ªè£½æ°´æœ
        function drawItems() {
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for(let item of items) {
                ctx.fillText(
                    item.emoji, 
                    item.x * gridSize + gridSize/2, 
                    item.y * gridSize + gridSize/2 + 2
                );
            }
        }
        
        // ç¹ªè£½ç‚¸å½ˆ
        function drawBomb() {
            if(!bomb) return;
            
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // å¦‚æœç‚¸å½ˆå³å°‡æ¶ˆå¤±ï¼Œæ·»åŠ é–ƒçˆæ•ˆæœ
            const timeLeft = bomb.duration - (Date.now() - bomb.spawnTime);
            if (timeLeft < 2000) {
                // é–ƒçˆæ•ˆæœï¼šæ¯250msåˆ‡æ›ä¸€æ¬¡
                const shouldShow = Math.floor(Date.now() / 250) % 2 === 0;
                if (shouldShow) {
                    ctx.fillText(
                        bomb.emoji, 
                        bomb.x * gridSize + gridSize/2, 
                        bomb.y * gridSize + gridSize/2 + 2
                    );
                }
                
                // æ·»åŠ ç´…è‰²è­¦ç¤ºåœˆ
                if (settings.showEffects) {
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(
                        bomb.x * gridSize + gridSize/2,
                        bomb.y * gridSize + gridSize/2,
                        gridSize/2 + 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.stroke();
                }
            } else {
                ctx.fillText(
                    bomb.emoji, 
                    bomb.x * gridSize + gridSize/2, 
                    bomb.y * gridSize + gridSize/2 + 2
                );
            }
        }
        
        // ç¹ªè£½ç²’å­æ•ˆæœ
        function drawParticles() {
            if (!settings.showEffects) return;
            
            for(let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.alpha;
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1.0;
                
                // æ›´æ–°ç²’å­
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.02;
                p.size *= 0.95;
                
                // ç§»é™¤æ¶ˆå¤±çš„ç²’å­
                if (p.alpha <= 0 || p.size <= 0.5) {
                    particles.splice(i, 1);
                }
            }
        }
        
        // ç¹ªè£½è›‡
        function drawSnake() {
            snake.forEach((part, index) => {
                // è›‡é ­ä½¿ç”¨è¼ƒäº®é¡è‰²
                if(index === 0) {
                    ctx.fillStyle = lightenColor(skinColor, 30);
                    
                    // ç¹ªè£½çœ¼ç›
                    ctx.fillStyle = '#fff';
                    let eyeX1 = part.x * gridSize + 4;
                    let eyeX2 = part.x * gridSize + 12;
                    let eyeY = part.y * gridSize + 4;
                    
                    // æ ¹æ“šæ–¹å‘èª¿æ•´çœ¼ç›ä½ç½®
                    if (direction === 'right') {
                        eyeX1 = part.x * gridSize + 12;
                        eyeX2 = part.x * gridSize + 12;
                        eyeY = part.y * gridSize + 6;
                    } else if (direction === 'left') {
                        eyeX1 = part.x * gridSize + 4;
                        eyeX2 = part.x * gridSize + 4;
                        eyeY = part.y * gridSize + 6;
                    } else if (direction === 'up') {
                        eyeX1 = part.x * gridSize + 6;
                        eyeX2 = part.x * gridSize + 12;
                        eyeY = part.y * gridSize + 4;
                    } else if (direction === 'down') {
                        eyeX1 = part.x * gridSize + 6;
                        eyeX2 = part.x * gridSize + 12;
                        eyeY = part.y * gridSize + 12;
                    }
                    
                    ctx.fillRect(eyeX1, eyeY, 4, 4);
                    ctx.fillRect(eyeX2, eyeY, 4, 4);
                    ctx.fillStyle = lightenColor(skinColor, 30);
                } else {
                    // è›‡èº«ä½¿ç”¨æ¼¸è®Šé€æ˜åº¦
                    const alpha = 1 - (index / snake.length) * 0.6;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = skinColor;
                }
                
                // ç¹ªè£½è›‡èº«
                ctx.fillRect(part.x * gridSize + 1, part.y * gridSize + 1, gridSize - 2, gridSize - 2);
                
                // é‡ç½®é€æ˜åº¦
                ctx.globalAlpha = 1.0;
                
                // æ·»åŠ è›‡èº«å…§éƒ¨æ•ˆæœ
                if(index > 0) {
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    ctx.fillRect(part.x * gridSize + 4, part.y * gridSize + 4, gridSize - 8, gridSize - 8);
                }
            });
            
            // æ·»åŠ è›‡å°¾æ‹–å°¾æ•ˆæœ
            if (settings.showEffects && snake.length > 5) {
                const tail = snake[snake.length - 1];
                createParticles(
                    tail.x * gridSize + gridSize/2,
                    tail.y * gridSize + gridSize/2,
                    skinColor,
                    1
                );
            }
        }
        
        // é¡è‰²äº®åŒ–å‡½æ•¸
        function lightenColor(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            
            return `#${(
                0x1000000 + 
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1)}`;
        }
        
        // å‰µå»ºç²’å­æ•ˆæœ
        function createParticles(x, y, color, count) {
            if (!settings.showEffects) return;
            
            for(let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 5 + 2,
                    color: color,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    alpha: 1.0
                });
            }
        }
        
        // é¡¯ç¤ºé€£æ“Šæ•ˆæœ
        function showComboEffect(count) {
            if (count < 3) return;
            
            comboDisplay.textContent = `${count} é€£æ“Š!`;
            comboDisplay.style.display = 'block';
            comboDisplay.style.opacity = 1;
            
            // æ ¹æ“šé€£æ“Šæ•¸èª¿æ•´å­—é«”å¤§å°å’Œé¡è‰²
            let fontSize = 2.0;
            let color = '#ffd700';
            
            if (count >= 10) {
                fontSize = 3.0;
                color = '#ff0000';
            } else if (count >= 7) {
                fontSize = 2.8;
                color = '#ff6b6b';
            } else if (count >= 5) {
                fontSize = 2.5;
                color = '#4dff91';
            }
            
            comboDisplay.style.fontSize = `${fontSize}rem`;
            comboDisplay.style.color = color;
            comboDisplay.style.textShadow = `0 0 10px ${color}`;
            
            // æ·¡å‡ºæ•ˆæœ
            setTimeout(() => {
                comboDisplay.style.opacity = 0;
                setTimeout(() => {
                    comboDisplay.style.display = 'none';
                }, 500);
            }, 1000);
        }
        
        // éŠæˆ²é‚è¼¯æ›´æ–°
        function update() {
            // æª¢æŸ¥ç‚¸å½ˆæ™‚é–“
            if(bomb) {
                if(Date.now() - bomb.spawnTime > bomb.duration) {
                    // ç‚¸å½ˆæ¶ˆå¤±ï¼Œå¢åŠ ç‚¸å½ˆèº²é¿çµ±è¨ˆ
                    gameStats.bombsAvoided++;
                    saveGameStats();
                    
                    bomb = null;
                    setTimeout(generateBomb, 1000);
                }
            }
            
            // æ›´æ–°æ–¹å‘
            direction = nextDirection;
            let head = {x: snake[0].x, y: snake[0].y};
            
            // æ ¹æ“šæ–¹å‘ç§»å‹•é ­éƒ¨
            if(direction === 'up') head.y--;
            if(direction === 'down') head.y++;
            if(direction === 'left') head.x--;
            if(direction === 'right') head.x++;
            
            // ç¢°æ’æª¢æ¸¬
            if(head.x < 0 || head.x >= gridWidth || head.y < 0 || head.y >= gridHeight || checkCollision(head)) {
                gameOver();
                return;
            }
            
            // æ–°å¢ï¼šç”Ÿå­˜æ¨¡å¼éšœç¤™ç‰©ç¢°æ’æª¢æ¸¬
            if (currentMode === 'survival') {
                for(let obstacle of obstacles) {
                    if(head.x === obstacle.x && head.y === obstacle.y) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // ç§»å‹•è›‡
            snake.unshift(head);
            
            // æª¢æŸ¥æ˜¯å¦åƒåˆ°æ°´æœ
            let ate = false;
            for(let i = 0; i < items.length; i++) {
                if(head.x === items[i].x && head.y === items[i].y) {
                    // å¢åŠ åˆ†æ•¸
                    score += items[i].scoreVal;
                    scoreEl.innerText = score;
                    
                    // æ›´æ–°æ°´æœæ”¶é›†çµ±è¨ˆ
                    if (items[i].type === 'apple') {
                        gameStats.fruitsCollected.apple++;
                    } else if (items[i].type === 'grape') {
                        gameStats.fruitsCollected.grape++;
                    }
                    
                    // å‰µå»ºç²’å­æ•ˆæœ
                    createParticles(
                        head.x * gridSize + gridSize/2,
                        head.y * gridSize + gridSize/2,
                        items[i].type === 'apple' ? '#ff4d4d' : '#9b59b6',
                        10
                    );
                    
                    // ç§»é™¤è¢«åƒæ‰çš„æ°´æœä¸¦ç”Ÿæˆæ–°çš„
                    items.splice(i, 1);
                    spawnOneItem();
                    
                    // å¢åŠ é€£æ“Š
                    combo++;
                    comboCount.innerText = combo;
                    
                    // é¡¯ç¤ºé€£æ“Šæ•ˆæœ
                    if (combo >= 3) {
                        showComboEffect(combo);
                    }
                    
                    // é‡ç½®é€£æ“Šè¨ˆæ™‚å™¨
                    if (comboTimeout) clearTimeout(comboTimeout);
                    comboTimeout = setTimeout(() => {
                        if (combo > gameStats.maxCombo) {
                            gameStats.maxCombo = combo;
                            saveGameStats();
                        }
                        combo = 0;
                        comboCount.innerText = 0;
                    }, 2000);
                    
                    ate = true;
                    break;
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦åƒåˆ°ç‚¸å½ˆ
            if(bomb && head.x === bomb.x && head.y === bomb.y) {
                score += bomb.scoreVal;
                scoreEl.innerText = score;
                snake.pop(); // åƒåˆ°ç‚¸å½ˆæ¸›å°‘é•·åº¦
                
                // å‰µå»ºçˆ†ç‚¸æ•ˆæœ
                createParticles(
                    head.x * gridSize + gridSize/2,
                    head.y * gridSize + gridSize/2,
                    '#ff4d4d',
                    15
                );
                
                bomb = null;
                triggerShake();
                setTimeout(generateBomb, 1000);
                
                // é‡ç½®é€£æ“Š
                if (combo > gameStats.maxCombo) {
                    gameStats.maxCombo = combo;
                    saveGameStats();
                }
                combo = 0;
                comboCount.innerText = 0;
                if (comboTimeout) clearTimeout(comboTimeout);
                
                ate = true;
            }
            
            // å¦‚æœæ²’æœ‰åƒåˆ°æ±è¥¿ï¼Œç§»é™¤å°¾éƒ¨
            if(!ate) {
                snake.pop();
            }
            
            // éš¨éŠæˆ²é€²è¡Œå¢åŠ é€Ÿåº¦
            if(score > 0 && score % 50 === 0) {
                const setting = difficultySettings[currentDifficulty];
                if(gameSpeed > setting.minSpeed) {
                    gameSpeed -= 5;
                }
            }
            
            // ç”Ÿå­˜æ¨¡å¼ï¼šå®šæœŸç”Ÿæˆéšœç¤™ç‰©
            if (currentMode === 'survival' && gameTime > 0 && gameTime % difficultySettings[currentDifficulty].obstacleSpawnTime === 0) {
                generateObstacle();
            }
        }
        
        // ç¢°æ’æª¢æ¸¬
        function checkCollision(head) {
            for(let part of snake) {
                if(part.x === head.x && part.y === head.y) return true;
            }
            return false;
        }
        
        // éœ‡å‹•æ•ˆæœ
        function triggerShake() {
            canvas.classList.add('shake');
            setTimeout(() => canvas.classList.remove('shake'), 500);
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameStep() {
            if(!gameRunning || gamePaused) return;
            update();
            drawGame();
            gameLoop = setTimeout(gameStep, gameSpeed);
        }
        
        // éŠæˆ²çµæŸ
        function gameOver() {
            gameRunning = false;
            gamePaused = false;
            clearTimeout(gameLoop);
            clearInterval(gameTimer);
            
            // æ›´æ–°éŠæˆ²çµ±è¨ˆ
            gameStats.gamesPlayed++;
            if (score > gameStats.highScore) {
                gameStats.highScore = score;
            }
            
            // æ¨¡å¼ç‰¹å®šçµ±è¨ˆ
            if (currentMode === 'time') {
                if (score > gameStats.timeModeScore) {
                    gameStats.timeModeScore = score;
                }
            } else if (currentMode === 'survival') {
                if (gameTime > gameStats.survivalTime) {
                    gameStats.survivalTime = gameTime;
                }
            }
            
            saveGameStats();
            
            // æª¢æŸ¥ä¸¦è§£é–æˆå°±
            checkAchievements();
            
            // æ›´æ–°éŠæˆ²çµæŸç•«é¢
            finalScoreEl.innerText = score;
            finalModeEl.innerText = gameModes[currentMode].name;
            finalDiffEl.innerText = difficultySettings[currentDifficulty].name;
            finalTimeEl.innerText = formatTime(gameTime);
            
            // æª¢æŸ¥æ˜¯å¦æ‰“ç ´ç´€éŒ„
            const scoreKey = `${currentMode}_${currentDifficulty}`;
            if(score > highScores[scoreKey]) {
                highScores[scoreKey] = score;
                localStorage.setItem('snakeHighScores', JSON.stringify(highScores));
                highScoreEl.innerText = score;
                newRecordMsg.style.display = 'block';
            } else {
                newRecordMsg.style.display = 'none';
            }
            
            // é¡¯ç¤ºæœ¬æ¬¡éŠæˆ²è§£é–çš„æˆå°±
            displayUnlockedAchievements();
            
            // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
            gameOverScreen.style.display = 'block';
        }
        
        // æª¢æŸ¥æˆå°±
        function checkAchievements() {
            achievementDefinitions.forEach(achievement => {
                // å¦‚æœæˆå°±å·²ç¶“è§£é–ï¼Œè·³é
                if (achievements[achievement.id]) return;
                
                // æª¢æŸ¥æˆå°±æ¢ä»¶
                if (achievement.condition(gameStats)) {
                    // è§£é–æˆå°±
                    achievements[achievement.id] = true;
                    unlockedAchievements.add(achievement);
                    
                    // é¡¯ç¤ºæˆå°±å½ˆçª—
                    showAchievementPopup(achievement);
                }
            });
            
            // å„²å­˜æˆå°±ç‹€æ…‹
            localStorage.setItem('snakeAchievements', JSON.stringify(achievements));
        }
        
        // é¡¯ç¤ºæˆå°±å½ˆçª—
        function showAchievementPopup(achievement) {
            achievementName.textContent = achievement.name;
            achievementDesc.textContent = achievement.description;
            
            achievementPopup.style.display = 'block';
            achievementPopup.style.top = '20%';
            
            // 3ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                achievementPopup.style.display = 'none';
            }, 3000);
        }
        
        // é¡¯ç¤ºæœ¬æ¬¡éŠæˆ²è§£é–çš„æˆå°±
        function displayUnlockedAchievements() {
            if (unlockedAchievements.size === 0) {
                achievementsEarned.innerHTML = '';
                return;
            }
            
            let html = '<p>ğŸ‰ æœ¬æ¬¡è§£é–æˆå°±:</p>';
            unlockedAchievements.forEach(achievement => {
                html += `<p>${achievement.icon} ${achievement.name}</p>`;
            });
            
            achievementsEarned.innerHTML = html;
        }
        
        // å„²å­˜éŠæˆ²çµ±è¨ˆ
        function saveGameStats() {
            localStorage.setItem('snakeGameStats', JSON.stringify(gameStats));
        }
        
        // å„²å­˜éŠæˆ²è¨­å®š
        function saveSettings() {
            localStorage.setItem('snakeSettings', JSON.stringify(settings));
        }
        
        // è¼‰å…¥éŠæˆ²è¨­å®š
        function loadSettings() {
            document.getElementById('musicVolume').value = settings.musicVolume;
            document.getElementById('soundVolume').value = settings.soundVolume;
            document.getElementById('showEffects').checked = settings.showEffects;
        }
        
        // æ ¼å¼åŒ–æ™‚é–“ (ç§’è½‰ç‚º MM:SS)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°éŠæˆ²æ™‚é–“é¡¯ç¤º
        function updateGameTime() {
            if (!gameRunning || gamePaused) return;
            
            gameTime++;
            timeDisplay.textContent = formatTime(gameTime);
            
            // æ™‚é–“æŒ‘æˆ°æ¨¡å¼æª¢æŸ¥æ™‚é–“é™åˆ¶
            if (currentMode === 'time' && gameTime >= timeLimit) {
                gameOver();
            }
        }
        
        // è¼‰å…¥æˆå°±åˆ—è¡¨
        function loadAchievements() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            achievementDefinitions.forEach(achievement => {
                const isUnlocked = achievements[achievement.id] || false;
                
                const achievementEl = document.createElement('div');
                achievementEl.className = `achievement-item ${isUnlocked ? '' : 'achievement-locked'}`;
                
                achievementEl.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <h4>${achievement.name}</h4>
                        <p>${achievement.description}</p>
                        <p><small>${isUnlocked ? 'âœ… å·²è§£é–' : 'ğŸ”’ æœªè§£é–'}</small></p>
                    </div>
                `;
                
                container.appendChild(achievementEl);
            });
        }
        
        // åˆ†äº«éŠæˆ²æˆç¸¾
        function shareScore() {
            // å‰µå»ºåˆ†äº«æ–‡å­—
            const shareText = `æˆ‘åœ¨è²ªé£Ÿè›‡å¢å¼·ç‰ˆç²å¾—äº† ${score} åˆ†ï¼\n` +
                            `æ¨¡å¼: ${gameModes[currentMode].name}\n` +
                            `å›°é›£åº¦: ${difficultySettings[currentDifficulty].name}\n` +
                            `#è²ªé£Ÿè›‡ #éŠæˆ²`;
            
            // å˜—è©¦ä½¿ç”¨ Web Share API
            if (navigator.share) {
                navigator.share({
                    title: 'è²ªé£Ÿè›‡å¢å¼·ç‰ˆæˆç¸¾',
                    text: shareText,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // é™ç´šæ–¹æ¡ˆï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('æˆç¸¾å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n' + shareText);
                }).catch(() => {
                    // å¦‚æœ clipboard API ä¸å¯ç”¨ï¼Œé¡¯ç¤ºåˆ†äº«æ–‡å­—
                    prompt('è«‹è¤‡è£½ä»¥ä¸‹æ–‡å­—åˆ†äº«æ‚¨çš„æˆç¸¾:', shareText);
                });
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initEventListeners() {
            // é–‹å§‹æŒ‰éˆ•
            document.getElementById('startBtn').onclick = () => {
                if(!gameRunning) {
                    if(gamePaused) {
                        gamePaused = false;
                    } else {
                        init();
                    }
                    gameRunning = true;
                    gameStep();
                    
                    // é–‹å§‹è¨ˆæ™‚å™¨
                    gameTimer = setInterval(updateGameTime, 1000);
                }
            };
            
            // æš«åœæŒ‰éˆ•
            document.getElementById('pauseBtn').onclick = () => {
                if(gameRunning) {
                    gamePaused = !gamePaused;
                    if(!gamePaused) {
                        gameStep();
                    }
                }
            };
            
            // é‡ç½®æŒ‰éˆ•
            document.getElementById('restartBtn').onclick = () => {
                gameRunning = false;
                gamePaused = false;
                clearTimeout(gameLoop);
                clearInterval(gameTimer);
                init();
            };
            
            // å†ç©ä¸€æ¬¡æŒ‰éˆ•
            document.getElementById('playAgainBtn').onclick = () => {
                gameOverScreen.style.display = 'none';
                init();
                gameRunning = true;
                gameStep();
                gameTimer = setInterval(updateGameTime, 1000);
            };
            
            // æ¨¡å¼é¸æ“‡
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    
                    // æ›´æ–°æ™‚é–“é™åˆ¶é¡¯ç¤º
                    if (currentMode === 'time') {
                        timeLimit = gameModes[currentMode].timeLimit;
                    }
                    
                    // é‡ç½®éŠæˆ²
                    if(gameRunning) {
                        gameRunning = false;
                        clearTimeout(gameLoop);
                        clearInterval(gameTimer);
                        gamePaused = false;
                        init();
                    } else {
                        init();
                    }
                };
            });
            
            // å›°é›£åº¦é¸æ“‡
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDifficulty = btn.dataset.diff;
                    gameSpeed = difficultySettings[currentDifficulty].speed;
                    
                    // æ›´æ–°æœ€é«˜åˆ†é¡¯ç¤º
                    const scoreKey = `${currentMode}_${currentDifficulty}`;
                    highScoreEl.innerText = highScores[scoreKey] || 0;
                    
                    if(gameRunning) {
                        gameRunning = false;
                        clearTimeout(gameLoop);
                        clearInterval(gameTimer);
                        gamePaused = false;
                        init();
                    } else {
                        init();
                    }
                };
            });
            
            // æˆå°±æŒ‰éˆ•
            document.getElementById('achievementsBtn').onclick = () => {
                loadAchievements();
                document.getElementById('achievementsModal').style.display = 'flex';
            };
            
            // åˆ†äº«æŒ‰éˆ•
            document.getElementById('shareBtn').onclick = shareScore;
            
            // è¨­å®šæŒ‰éˆ•
            document.getElementById('settingsBtn').onclick = () => {
                loadSettings();
                document.getElementById('settingsModal').style.display = 'flex';
            };
            
            // é—œé–‰æˆå°±æ¨¡æ…‹æ¡†
            document.getElementById('closeAchievements').onclick = () => {
                document.getElementById('achievementsModal').style.display = 'none';
            };
            
            // é—œé–‰è¨­å®šæ¨¡æ…‹æ¡†
            document.getElementById('closeSettings').onclick = () => {
                document.getElementById('settingsModal').style.display = 'none';
            };
            
            // å„²å­˜è¨­å®š
            document.getElementById('saveSettings').onclick = () => {
                settings.musicVolume = parseInt(document.getElementById('musicVolume').value);
                settings.soundVolume = parseInt(document.getElementById('soundVolume').value);
                settings.showEffects = document.getElementById('showEffects').checked;
                
                saveSettings();
                document.getElementById('settingsModal').style.display = 'none';
            };
            
            // æŒ‰éµç›£è½ (WASD + æ–¹å‘éµ)
            document.addEventListener('keydown', (e) => {
                const k = e.key;
                const c = e.code;
                
                // é˜²æ­¢æ»¾å‹•
                if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " ", "Spacebar"].includes(k) || 
                    c.startsWith("Key")) {
                    e.preventDefault();
                }
                
                // æ–¹å‘åˆ¤æ–·
                if ((k === 'ArrowUp' || k === 'w' || k === 'W' || c === 'KeyW') && direction !== 'down') {
                    nextDirection = 'up';
                } else if ((k === 'ArrowDown' || k === 's' || k === 'S' || c === 'KeyS') && direction !== 'up') {
                    nextDirection = 'down';
                } else if ((k === 'ArrowLeft' || k === 'a' || k === 'A' || c === 'KeyA') && direction !== 'right') {
                    nextDirection = 'left';
                } else if ((k === 'ArrowRight' || k === 'd' || k === 'D' || c === 'KeyD') && direction !== 'left') {
                    nextDirection = 'right';
                }
                
                // ç©ºæ ¼éµæš«åœ/ç¹¼çºŒ
                if (k === ' ' || k === 'Spacebar') {
                    if (gameRunning) {
                        gamePaused = !gamePaused;
                        if (!gamePaused) {
                            gameStep();
                        }
                    }
                }
                
                // Enteréµé–‹å§‹éŠæˆ²
                if (k === 'Enter' && !gameRunning) {
                    document.getElementById('startBtn').click();
                }
            });
        }
        
        // çš®è†šé¸æ“‡å‡½æ•¸
        window.setSkin = function(color, el) {
            skinColor = color;
            document.querySelectorAll('.skin-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            if(!gameRunning) drawGame();
        };
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.onload = function() {
            init();
            initEventListeners();
            loadSettings();
        };
    </script>
</body>
</html>